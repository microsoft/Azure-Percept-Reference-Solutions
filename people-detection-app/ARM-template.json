{
    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "resourceGroupDevice": {
            "type": "String",
            "metadata": {
                "description": "Enter the name of resource group which has existing IoT Hub and Edge Device."
            }
        },
        "resourceGroupAMS": {
            "defaultValue": "",
            "type": "String",
            "metadata": {
                "description": "Enter the name of resource group which will be used for Storage Account and Media Service."
            }
        },
        "existingIotHubName": {
            "type": "String",
            "metadata": {
                "description": "Enter the name of existing Iot Hub which has Azure Percept with Vision SoM Device"
            }
        },
        "existingDeviceName": {
            "type": "String",
            "metadata": {
                "description": "Enter the name of existing IoT Edge device (Azure Percept with Vision SoM) on Iot Hub."
            }
        },
        "servicePrincipalId": {
            "type": "String",
            "metadata": {
                "description": "Application ID of the service principal which will be used to configure LvaEdge module"
            }
        },
        "servicePrincipalObjectId": {
            "type": "String",
            "metadata": {
                "description": "Object ID of the service principal which will be assigned the custom role to configure LvaEdge module"
            }
        },
        "servicePrincipalSecret": {
            "type": "String",
            "metadata": {
                "description": "Secret of the service principal which will be used to configure LvaEdge module"
            }
        },
        "password": {
            "defaultValue": "",
            "type": "String",
            "metadata": {
                "description": "Specify the password for the web app."
            }
        }
    },
    "variables": {
        "location": "[deployment().location]",
        "resourceGroupAMS": "[if(equals(parameters('resourceGroupAMS'),''),parameters('resourceGroupDevice'),parameters('resourceGroupAMS'))]",
        "storageAccountName": "[concat('uesstorage',substring(uniqueString(subscription().id,variables('resourceGroupAMS')),1,4))]",
        "deploymentName": "[concat('percept-deployment',substring(uniqueString(subscription().id,variables('resourceGroupAMS')),1,4))]",
        "managedIdentityName": "[concat('Managed_Identity',substring(uniqueString(subscription().id,variables('resourceGroupAMS')),1,5))]",
        "managedIdentityResourceGroup": "[variables('resourceGroupAMS')]",
        "mediaServiceName": "[concat('livevideoanalysis',substring(uniqueString(subscription().id,variables('resourceGroupAMS')),1,4))]",
        "applicationType": "people-tracking-azurepercept-device",
        "streamingLocator": "[concat('StreamingLocator',substring(uniqueString(subscription().id,variables('resourceGroupAMS')),1,4))]",
        "webappName": "[concat('ues-perceptapp',substring(uniqueString(subscription().id,variables('resourceGroupAMS')),1,4))]",
        "appServiceName": "[concat('ues-perceptasp',substring(uniqueString(subscription().id,variables('resourceGroupAMS')),1,4))]",
        "graphTopology": "CVRToAMSAsset",
        "graphInstance": "AzurePerceptVisionSOM"
    },
    "resources": [
        {
            "type": "Microsoft.Resources/resourceGroups",
            "apiVersion": "2020-06-01",
            "name": "[variables('resourceGroupAMS')]",
            "location": "[variables('location')]",
            "properties": {},
            "condition": "[not(equals(parameters('resourceGroupDevice'),variables('resourceGroupAMS')))]"
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "ResourcesDeployment",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups/', variables('resourceGroupAMS'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "parameters": {
                    "resourceGroupAMS": {
                        "value": "[parameters('resourceGroupAMS')]"
                    },
                    "resourceGroupDevice": {
                        "value": "[parameters('resourceGroupDevice')]"
                    },
                    "resourceGroupLocation": {
                        "value": "[variables('location')]"
                    },
                    "storageAccountName": {
                        "value": "[variables('storageAccountName')]"
                    },
                    "accountType": {
                        "value": "Standard_RAGRS"
                    },
                    "kind": {
                        "value": "StorageV2"
                    },
                    "isHnsEnabled": {
                        "value": true
                    },
                    "mediaServiceName": {
                        "value": "[variables('mediaServiceName')]"
                    },
                    "applicationType": {
                        "value": "[variables('applicationType')]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "resourceGroupAMS": {
                            "type": "String"
                        },
                        "resourceGroupDevice": {
                            "type": "String"
                        },
                        "StorageAccountName": {
                            "type": "String"
                        },
                        "resourceGroupLocation": {
                            "type": "String"
                        },
                        "accountType": {
                            "type": "String"
                        },
                        "kind": {
                            "type": "String"
                        },
                        "isHnsEnabled": {
                            "type": "Bool"
                        },
                        "accountSasProperties": {
                            "type": "Object",
                            "defaultValue": {
                                "signedServices": "b",
                                "signedPermission": "lr",
                                "signedExpiry": "[dateTimeAdd(utcNow('u'), 'P1Y')]",
                                "signedResourceTypes": "sco"
                            }
                        },
                        "applicationType": {
                            "type": "String"
                        },
                        "mediaServiceName": {
                            "type": "String"
                        }
                    },
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Storage/storageAccounts",
                            "apiVersion": "2019-06-01",
                            "name": "[parameters('StorageAccountName')]",
                            "location": "[parameters('resourceGroupLocation')]",
                            "dependsOn": [],
                            "tags": {
                                "type": "[parameters('applicationType')]"
                            },
                            "sku": {
                                "name": "[parameters('accountType')]"
                            },
                            "kind": "[parameters('kind')]",
                            "properties": {
                                "accessTier": "Hot",
                                "minimumTlsVersion": "TLS1_0",
                                "supportsHttpsTrafficOnly": true,
                                "allowBlobPublicAccess": true,
                                "networkAcls": {
                                    "bypass": "AzureServices",
                                    "defaultAction": "Allow",
                                    "ipRules": []
                                },
                                "isHnsEnabled": "[parameters('isHnsEnabled')]"
                            }
                        },
                        {
                            "type": "Microsoft.Storage/storageAccounts/blobServices",
                            "apiVersion": "2019-06-01",
                            "name": "[concat(parameters('StorageAccountName'), '/default')]",
                            "dependsOn": [
                                "[parameters('StorageAccountName')]"
                            ],
                            "sku": {
                                "name": "Standard_RAGRS",
                                "tier": "Standard"
                            },
                            "properties": {
                                "cors": {
                                    "corsRules": [
                                        {
                                            "allowedOrigins": [
                                                "*"
                                            ],
                                            "allowedMethods": [
                                                "GET",
                                                "HEAD"
                                            ],
                                            "maxAgeInSeconds": 1000,
                                            "exposedHeaders": [
                                                "*"
                                            ],
                                            "allowedHeaders": [
                                                "*"
                                            ]
                                        }
                                    ]
                                },
                                "deleteRetentionPolicy": {
                                    "enabled": false
                                }
                            }
                        },
                        {
                            "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
                            "apiVersion": "2019-06-01",
                            "name": "[concat(parameters('StorageAccountName'), '/default/detectoroutput')]",
                            "dependsOn": [
                                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('StorageAccountName'), 'default')]",
                                "[parameters('StorageAccountName')]"
                            ],
                            "properties": {
                                "publicAccess": "None"
                            }
                        },
                        {
                            "name": "[parameters('mediaServiceName')]",
                            "type": "Microsoft.Media/mediaServices",
                            "apiVersion": "2018-07-01",
                            "location": "[resourceGroup().location]",
                            "dependsOn": [
                                "[parameters('storageAccountName')]"
                            ],
                            "properties": {
                                "storageAccounts": [
                                    {
                                        "id": "[resourceId('microsoft.storage/storageaccounts/', parameters('storageAccountName'))]",
                                        "type": "Primary"
                                    }
                                ]
                            }
                        }
                    ],
                    "outputs": {
                        "sasToken": {
                            "type": "string",
                            "value": "[listAccountSas(parameters('StorageAccountName'), '2018-07-01', parameters('accountSasProperties')).accountSasToken]"
                        }
                    }
                }
            },
            "resourceGroup": "[variables('resourceGroupAMS')]"
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "IoTHubDeployment",
            "dependsOn": [
                "ResourcesDeployment"
            ],
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "parameters": {
                    "StorageAccountName": {
                        "value": "[variables('storageAccountName')]"
                    },
                    "iotHubName": {
                        "value": "[parameters('existingIotHubName')]"
                    },
                    "resourceGroupLocation": {
                        "value": "[variables('location')]"
                    },
                    "applicationType": {
                        "value": "[variables('applicationType')]"
                    },
                    "resourceGroupAMS": {
                        "value": "[variables('resourceGroupAMS')]"
                    }
                },
                "template": {
                    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "StorageAccountName": {
                            "type": "String"
                        },
                        "iotHubName": {
                            "type": "string"
                        },
                        "resourceGroupLocation": {
                            "type": "String"
                        },
                        "applicationType": {
                            "type": "String"
                        },
                        "resourceGroupAMS": {
                            "type": "String"
                        }
                    },
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Devices/IotHubs",
                            "apiVersion": "2020-04-01",
                            "name": "[parameters('iotHubName')]",
                            "dependsOn": [],
                            "location": "[parameters('resourceGroupLocation')]",
                            "sku": {
                                "name": "S1",
                                "tier": "Standard",
                                "capacity": 1
                            },
                            "identity": {
                                "type": "None"
                            },
                            "tags": {
                                "type": "[parameters('applicationType')]"
                            },
                            "properties": {
                                "ipFilterRules": [],
                                "eventHubEndpoints": {
                                    "events": {
                                        "retentionTimeInDays": 1,
                                        "partitionCount": 4
                                    }
                                },
                                "routing": {
                                    "endpoints": {
                                        "storageContainers": [
                                            {
                                                "connectionString": "[Concat('DefaultEndpointsProtocol=https;EndpointSuffix=core.windows.net;AccountName=',parameters('storageAccountName'),';AccountKey=',listKeys(resourceId(parameters('resourceGroupAMS'), 'Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2019-06-01').keys[0].value)]",
                                                "containerName": "detectoroutput",
                                                "fileNameFormat": "{iothub}/{partition}/{YYYY}/{MM}/{DD}/{HH}/{mm}.json",
                                                "batchFrequencyInSeconds": 60,
                                                "maxChunkSizeInBytes": 104857600,
                                                "encoding": "json",
                                                "name": "adls-endpoint"
                                            }
                                        ]
                                    },
                                    "routes": [
                                        {
                                            "name": "adls-route",
                                            "source": "DeviceMessages",
                                            "condition": "$twin.moduleId = 'AzurePerceptModule'",
                                            "endpointNames": [
                                                "adls-endpoint"
                                            ],
                                            "isEnabled": true
                                        },
                                        {
                                            "name": "default",
                                            "source": "DeviceMessages",
                                            "condition": "true",
                                            "endpointNames": [
                                                "events"
                                            ],
                                            "isEnabled": true
                                        }
                                    ],
                                    "fallbackRoute": {
                                        "name": "$fallback",
                                        "source": "DeviceMessages",
                                        "condition": "true",
                                        "endpointNames": [
                                            "events"
                                        ],
                                        "isEnabled": true
                                    }
                                }
                            }
                        }
                    ]
                }
            },
            "resourceGroup": "[parameters('resourceGroupDevice')]"
        },
        {
            "type": "Microsoft.Authorization/roleAssignments",
            "apiVersion": "2018-09-01-preview",
            "name": "[guid(concat(subscription().id, parameters('servicePrincipalId'), 'LVAEdgeUserRole'))]",
            "properties": {
                "roleDefinitionId": "[concat(resourceGroup().id, '/providers/Microsoft.Authorization/roleDefinitions/', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                "principalId": "[parameters('servicePrincipalObjectId')]",
                "scope": "[subscription().id]",
                "principalType": "ServicePrincipal"
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "CreatingManagedIdentity",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups/', variables('resourceGroupAMS'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
                            "name": "[variables('managedIdentityName')]",
                            "apiVersion": "2018-11-30",
                            "location": "[variables('location')]"
                        }
                    ]
                }
            },
            "resourceGroup": "[variables('resourceGroupAMS')]"
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "CreatingRoleAssignments",
            "dependsOn": [
                "CreatingManagedIdentity"
            ],
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "parameters": {
                    "managedIdentityName": {
                        "value": "[variables('managedIdentityName')]"
                    }
                },
                "template": {
                    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "managedIdentityName": {
                            "type": "String"
                        }
                    },
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Authorization/roleAssignments",
                            "apiVersion": "2018-09-01-preview",
                            "name": "[guid(concat(resourceGroup().id, parameters('managedIdentityName'), 'contributor'))]",
                            "properties": {
                                "roleDefinitionId": "[concat(resourceGroup().id, '/providers/Microsoft.Authorization/roleDefinitions/', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName')), '2018-11-30').principalId]",
                                "scope": "[resourceGroup().id]",
                                "principalType": "ServicePrincipal"
                            }
                        }
                    ]
                }
            },
            "resourceGroup": "[variables('resourceGroupAMS')]"
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "CreatingRoleAssignmentsDevice",
            "dependsOn": [
                "CreatingManagedIdentity"
            ],
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "parameters": {
                    "managedIdentityName": {
                        "value": "[variables('managedIdentityName')]"
                    },
                    "resourceGroupDevice": {
                        "value": "[parameters('resourceGroupDevice')]"
                    },
                    "resourceGroupAMS": {
                        "value": "[variables('resourceGroupAMS')]"
                    }
                },
                "template": {
                    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "managedIdentityName": {
                            "type": "String"
                        },
                        "resourceGroupDevice": {
                            "type": "String"
                        },
                        "resourceGroupAMS": {
                            "type": "String"
                        }
                    },
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Authorization/roleAssignments",
                            "apiVersion": "2018-09-01-preview",
                            "name": "[guid(concat(resourceGroup().id, parameters('managedIdentityName'), 'contributor', 'Device'))]",
                            "properties": {
                                "roleDefinitionId": "[concat('/subscriptions/' , subscription().subscriptionId , '/resourceGroups/', parameters('resourceGroupDevice'),  '/providers/Microsoft.Authorization/roleDefinitions/', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
                                "principalId": "[reference(resourceId(parameters('resourceGroupAMS'),'Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName')), '2018-11-30').principalId]",
                                "scope": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', parameters('resourceGroupDevice'))]",
                                "principalType": "ServicePrincipal"
                            }
                        }
                    ]
                }
            },
            "resourceGroup": "[parameters('resourceGroupDevice')]",
            "condition": "[not(equals(parameters('resourceGroupDevice'),variables('resourceGroupAMS')))]"
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "AzurePerceptDeployment",
            "dependsOn": [
                "CreatingRoleAssignments",
                "CreatingRoleAssignmentsDevice",
                "IoTHubDeployment"
            ],
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "parameters": {
                    "resourceGroupDevice": {
                        "value": "[parameters('resourceGroupDevice')]"
                    },
                    "resourceGroupAMS": {
                        "value": "[variables('resourceGroupAMS')]"
                    },
                    "StorageAccountName": {
                        "value": "[variables('storageAccountName')]"
                    },
                    "iotHubName": {
                        "value": "[parameters('existingIotHubName')]"
                    },
                    "resourceGroupLocation": {
                        "value": "[variables('location')]"
                    },
                    "managedIdentityResourceGroup": {
                        "value": "[variables('managedIdentityResourceGroup')]"
                    },
                    "managedIdentityName": {
                        "value": "[variables('managedIdentityName')]"
                    },
                    "deviceName": {
                        "value": "[parameters('existingDeviceName')]"
                    },
                    "deploymentName": {
                        "value": "[variables('deploymentName')]"
                    },
                    "SP_APP_ID": {
                        "value": "[parameters('servicePrincipalId')]"
                    },
                    "SP_APP_PWD": {
                        "value": "[parameters('servicePrincipalSecret')]"
                    },
                    "mediaServiceName": {
                        "value": "[variables('mediaServiceName')]"
                    },
                    "applicationType": {
                        "value": "[variables('applicationType')]"
                    },
                    "graphTopology": {
                        "value": "[variables('graphTopology')]"
                    },
                    "graphInstance": {
                        "value": "[variables('graphInstance')]"
                    },
                    "streamingLocator": {
                        "value": "[variables('streamingLocator')]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "resourceGroupDevice": {
                            "type": "String"
                        },
                        "resourceGroupAMS": {
                            "type": "String"
                        },
                        "StorageAccountName": {
                            "type": "String"
                        },
                        "iotHubName": {
                            "type": "string"
                        },
                        "resourceGroupLocation": {
                            "type": "String"
                        },
                        "managedIdentityResourceGroup": {
                            "type": "String"
                        },
                        "managedIdentityName": {
                            "type": "String"
                        },
                        "deviceName": {
                            "type": "String"
                        },
                        "deploymentName": {
                            "type": "String"
                        },
                        "applicationType": {
                            "type": "String"
                        },
                        "utcValue": {
                            "type": "string",
                            "defaultValue": "[utcNow()]"
                        },
                        "SP_APP_ID": {
                            "type": "String"
                        },
                        "SP_APP_PWD": {
                            "type": "String"
                        },
                        "mediaServiceName": {
                            "type": "String"
                        },
                        "graphTopology": {
                            "type": "String"
                        },
                        "graphInstance": {
                            "type": "String"
                        },
                        "streamingLocator": {
                            "type": "String"
                        }
                    },
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Resources/deploymentScripts",
                            "apiVersion": "2019-10-01-preview",
                            "name": "ModuleDeployment",
                            "dependsOn": [],
                            "location": "[parameters('resourceGroupLocation')]",
                            "kind": "AzureCLI",
                            "identity": {
                                "type": "UserAssigned",
                                "userAssignedIdentities": {
                                    "[concat(subscription().id,'/resourceGroups/', parameters('managedIdentityResourceGroup'),'/providers/Microsoft.ManagedIdentity/userAssignedIdentities/',parameters('managedIdentityName'))]": {}
                                }
                            },
                            "tags": {
                                "type": "[parameters('applicationType')]"
                            },
                            "properties": {
                                "forceUpdateTag": "1",
                                "azCliVersion": "2.9.1",
                                "primaryScriptUri": "https://unifiededgescenarios.blob.core.windows.net/arm-template/azure-percept/latest/arm-internal-deploy-modules-percept.sh",
                                "supportingScriptUris": [],
                                "environmentVariables": [
                                    {
                                        "name": "IOTHUB_NAME",
                                        "value": "[parameters('iotHubName')]"
                                    },
                                    {
                                        "name": "STORAGE_ACCOUNT_NAME",
                                        "value": "[parameters('StorageAccountName')]"
                                    },
                                    {
                                        "name": "RESOURCE_GROUP_DEVICE",
                                        "value": "[parameters('resourceGroupDevice')]"
                                    },
                                    {
                                        "name": "RESOURCE_GROUP_AMS",
                                        "value": "[parameters('resourceGroupAMS')]"
                                    },
                                    {
                                        "name": "DEVICE_NAME",
                                        "value": "[parameters('deviceName')]"
                                    },
                                    {
                                        "name": "DEPLOYMENT_NAME",
                                        "value": "[concat(parameters('deploymentName'),parameters('utcValue'))]"
                                    },
                                    {
                                        "name": "IDENTITY_NAME",
                                        "value": "[parameters('managedIdentityName')]"
                                    },
                                    {
                                        "name": "SP_APP_ID",
                                        "value": "[parameters('SP_APP_ID')]"
                                    },
                                    {
                                        "name": "SP_APP_PWD",
                                        "value": "[parameters('SP_APP_PWD')]"
                                    },
                                    {
                                        "name": "TENANT_ID",
                                        "value": "[subscription().tenantId]"
                                    },
                                    {
                                        "name": "SUBSCRIPTION_ID",
                                        "value": "[subscription().subscriptionId]"
                                    },
                                    {
                                        "name": "AMS_ACCOUNT_NAME",
                                        "value": "[parameters('mediaServiceName')]"
                                    },
                                    {
                                        "name": "GRAPH_TOPOLOGY_NAME",
                                        "value": "[parameters('graphTopology')]"
                                    },
                                    {
                                        "name": "GRAPH_INSTANCE_NAME",
                                        "value": "[parameters('graphInstance')]"
                                    },
                                    {
                                        "name": "STREAMING_LOCATOR",
                                        "value": "[parameters('streamingLocator')]"
                                    }
                                ],
                                "retentionInterval": "P1D",
                                "timeout": "PT50M",
                                "containerSettings": {},
                                "cleanupPreference": "OnSuccess"
                            }
                        }
                    ],
                    "outputs": {
                        "STREAMING_URL": {
                            "type": "String",
                            "value": "[reference('ModuleDeployment').outputs.STREAMING_URL]"
                        }
                    }
                }
            },
            "resourceGroup": "[variables('resourceGroupAMS')]"
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "name": "AppServicePlanDeployment",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups/', variables('resourceGroupAMS'))]",
                "AzurePerceptDeployment"
            ],
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Web/serverfarms",
                            "apiVersion": "2018-02-01",
                            "name": "[variables('appServiceName')]",
                            "location": "[variables('location')]",
                            "sku": {
                                "name": "S1",
                                "tier": "Standard",
                                "size": "S1",
                                "family": "S",
                                "capacity": 1
                            },
                            "kind": "app",
                            "tags": {
                                "type": "[variables('applicationType')]"
                            },
                            "properties": {
                                "perSiteScaling": false,
                                "maximumElasticWorkerCount": 1,
                                "isSpot": false,
                                "reserved": false,
                                "isXenon": false,
                                "hyperV": false,
                                "targetWorkerCount": 0,
                                "targetWorkerSizeId": 0
                            }
                        },
                        {
                            "type": "Microsoft.Web/sites",
                            "apiVersion": "2018-11-01",
                            "name": "[variables('webappName')]",
                            "location": "[variables('location')]",
                            "dependsOn": [
                                "[variables('appServiceName')]"
                            ],
                            "tags": {
                                "edgeAIAppDeployment": "people-tracking-app",
                                "type": "[variables('applicationType')]"
                            },
                            "kind": "app",
                            "properties": {
                                "enabled": true,
                                "hostNameSslStates": [
                                    {
                                        "name": "[concat(variables('webappName'), '.azurewebsites.net')]",
                                        "sslState": "Disabled",
                                        "hostType": "Standard"
                                    },
                                    {
                                        "name": "[concat(variables('webappName'), '.scm.azurewebsites.net')]",
                                        "sslState": "Disabled",
                                        "hostType": "Repository"
                                    }
                                ],
                                "serverFarmId": "[concat(subscription().id,'/resourceGroups/',variables('resourceGroupAMS'),'/providers/Microsoft.Web/serverfarms/', variables('appServiceName'))]",
                                "reserved": false,
                                "isXenon": false,
                                "hyperV": false,
                                "siteConfig": {},
                                "scmSiteAlsoStopped": false,
                                "clientAffinityEnabled": true,
                                "clientCertEnabled": false,
                                "hostNamesDisabled": false,
                                "containerSize": 0,
                                "dailyMemoryTimeQuota": 0,
                                "httpsOnly": false,
                                "redundancyMode": "None"
                            },
                            "resources": [
                                {
                                    "type": "config",
                                    "apiVersion": "2018-11-01",
                                    "name": "web",
                                    "dependsOn": [
                                        "[variables('webappName')]",
                                        "MSDeploy"
                                    ],
                                    "properties": {
                                        "webSocketsEnabled": true,
                                        "alwaysOn": true
                                    }
                                },
                                {
                                    "type": "config",
                                    "apiVersion": "2018-11-01",
                                    "name": "appsettings",
                                    "dependsOn": [
                                        "[variables('webappName')]",
                                        "MSDeploy"
                                    ],
                                    "properties": {
                                        "STORAGE_BLOB_ACCOUNT": "[variables('storageAccountName')]",
                                        "PASSWORD": "[parameters('password')]",
                                        "WEBSITE_HTTPLOGGING_RETENTION_DAYS": "7",
                                        "WEBSITE_NODE_DEFAULT_VERSION": "10.15.2",
                                        "AMP_STREAMING_URL": "[reference('AzurePerceptDeployment').outputs.STREAMING_URL.value]",
                                        "IOT_HUB_NAME": "[parameters('existingIotHubName')]",
                                        "STORAGE_BLOB_SHARED_ACCESS_SIGNATURE": "[reference('ResourcesDeployment').outputs.sasToken.value]"
                                    }
                                },
                                {
                                    "type": "Extensions",
                                    "apiVersion": "2018-11-01",
                                    "name": "MSDeploy",
                                    "location": "[variables('location')]",
                                    "dependsOn": [
                                        "[variables('webappName')]"
                                    ],
                                    "properties": {
                                        "packageUri": "https://unifiededgescenarios.blob.core.windows.net/arm-template/azure-percept/latest/people-detection-app.zip"
                                    }
                                }
                            ]
                        }
                    ]
                }
            },
            "resourceGroup": "[variables('resourceGroupAMS')]"
        }
    ],
    "outputs": {
        "WebAppURL": {
            "type": "string",
            "value": "[concat('https://', variables('webappName'), '.azurewebsites.net')]"
        }
    }
}